library(raster)
?removeTmpFiles()
removeTmpFiles(h = 0.15)
showTmpFiles()
showTmpFiles()
rasterOptions
rasterOptions()
install.packages('devtools')
install.packages('igraph')
install.packages('raster')
library(shiny)
library(rhapsody)
library(tidyverse)
### rhapsody
devtools::load_all("C:/Users/Oli/Documents/GitHub/LULCSD")
library(rhapsody)
### plotting functions
base.dir <- getwd()
for(i in list.files(path = paste0(base.dir, '/functions'), pattern = '*.R')) {source(paste0(base.dir, '/functions/', i))}
### model data
load('historical_run.RData')
getwd()
library(here)
install.packages('here')
library(here)
library(shiny)
library(tidyverse)
library(here)
### rhapsody
devtools::load_all("C:/Users/Oli/Documents/GitHub/LULCSD")
library(rhapsody)
### plotting functions
base.dir <- here()
for(i in list.files(path = paste0(base.dir, '/functions'), pattern = '*.R')) {source(paste0(base.dir, '/functions/', i))}
### model data
load(paste0(base.dir, '/future_run.RData'))
here()
library(RCurl)
?curl
?Curl
url <- ("ftp://ftp3.tpdc.ac.cn/")
getURL(url, userpwd="download_8978835:56893573",
ftp.use.epsv = FALSE, dirlistonly = TRUE)
?getURL
url <- ("ftp2.tpdc.ac.cn")
getURL(url, userpwd="download_8978835:56893573",
ftp.use.epsv = FALSE, dirlistonly = TRUE)
url <- ("https://ftp2.tpdc.ac.cn")
getURL(url, userpwd="download_8978835:56893573",
ftp.use.epsv = FALSE, dirlistonly = TRUE)
library(tidyverse)
library(terra)
library(tree)
set.seed(1987)
source('C:/Users/Oli/Documents/PhD/Model development/AFT Distribution/Beta version/Submodels/AFT_Distribution_Functions.R')
###############################################################################
### Load data
###############################################################################
setwd('C:/Users/Oli/Documents/PIES/Data/Secondary_Data')
JULES.mask<- rast("JULES_Mask_025.tif")
setwd('C:/Users/Oli/Documents/PIES/Data/Secondary_Data/Other_LULC')
Unoc <- rast('Very_low_impact_025.tif')
setwd('C:/Users/Oli/Documents/PIES/Data/Secondary_Data')
JULES.mask<- rast("JULES_Mask_025.tif")
setwd('C:/Users/Oli/Documents/PIES/Data/Secondary_Data/LUH2')
Pasture   <- rast('LUH2_pasture.tif')
Rangeland <- rast("LUH2_rangeland.tif")
Cropland  <- rast("LUH2_crop.tif")
Forest    <- rast('LUH2_primf.tif') + rast('LUH2_secdf.tif')
setwd('C:/Users/Oli/Documents/PIES/Data/Secondary_Data/Socio_economic/HDI_GDP')
HDI <- rast("HDI_025.tif")
GDP <- rast("GDP_025.tif")
setwd('C:/Users/Oli/Documents/PIES/Data/Secondary_Data/Socio_economic/Population')
Pop <- rast('Pop_025.tif')
setwd('C:/Users/Oli/Documents/PIES/Data/Secondary_Data/Socio_economic/MA')
MA  <- rast('Market_access.tif')
MI  <- MA * GDP
setwd('C:/Users/Oli/Documents/PIES/Data/Secondary_Data/Biophysical')
ET  <- rast('PET_025.tif')
NPP <- rast('NPP_025.tif')
DEM <- rast('DEM_025.tif')
#############################################################
### Make prediction frame
#############################################################
Combo.dat <- data.frame('Unoccupied' = Unoc[], 'Pop' = Pop[[26]][],
'HDI' = HDI[[26]][],
'Market_access' = MA[[26]][],
'NPP' = NPP[[26]][],
'DEM' = DEM[])
colnames(Combo.dat)  <- c('Unoccupied', 'Pop', 'HDI', 'Market_access','NPP', 'DEM',
'Cropland', 'Pasture')
colnames(Combo.dat)  <- c('Unoccupied', 'Pop', 'HDI', 'Market_access','NPP', 'DEM')
Combo.dat            <- Combo.dat[complete.cases(Combo.dat), ]
Combo.dat$AFT <- factor(Combo.dat$Unoccupied == 0)
set.seed(1987)
make_training_dat(Combo.dat, prob_key = '')
split.list       <- boot.tree(All.dat,
dat.weights = F,
form = c('AFT', 'Market_access', 'Pop', 'HDI', 'NPP', 'DEM'),
var.cols =  1:ncol(Train.dat), tree.method = 'class',
k = 1000, min_node = 50000,
tree.prune = 3) ## prune val from stage 1
splits           <- aggregate.boot_tree(split.list, 15)
n.nodes          <- table(unlist(lapply(split.list, function(x) {length(which(x$frame$var != '<leaf>'))})))
### choose trees
split.key        <- list('1' = 'Pop', '2' = 'Pop', '3' = 'Pop')
test.list        <- select.boot_tree(split.list, split.key)
split.list       <- test.list
remove(test.list)
### get tree components
splits           <- aggregate.boot_tree(split.list, 7)
splits           <- splits[sapply(splits, sum) == length(split.list)]
names(splits)    <- sort(as.numeric(row.names(split.list[[1]]$frame)))
thresholds       <- lapply(names(split.key), function(z) {
unlist(get.split_vals(split.list , as.character(z), as.character(split.key[z])))
})
probs            <- lapply(1:length(splits), function(i) {
if(as.numeric(splits[[as.numeric(names(splits)[i])]][1]) == length(split.list)) {
res <- get.leaf_probs(split.list, i)
} else {
res <- 'Node'
}
res
})
probs        <- lapply(probs, function(x) bind_rows(lapply(x, as.data.frame.list)))
names(probs) <- names(splits)
Final.tree   <- make.final_tree(split.list[[1]], split.key, thresholds, probs,
how = 'Median')
### result
Metrics::auc(as.numeric(All.dat$AFT)-1, predict(Final.tree, All.dat, type= 'vector')[, 2])
preds.frame           <- data.frame(Pop[[25]][], Pop[[26]][], Pop[[26]][], Pop[[26]][], Pop[[26]][], Pop[[26]][], Pop[[26]][])
colnames(preds.frame) <- c('Pop', 'HDI', 'Market_access','NPP', 'DEM',
'Cropland', 'Pasture')
combined.rast <- setValues(Pop[[25]], predict(ft, preds.frame))*(JULES.mask>0)
combined.rast <- setValues(Pop[[25]], predict(Final.tree, preds.frame))*(JULES.mask>0)
Pop[[25]]
preds.frame
JULES.mask>0
predict(Final.tree, preds.frame)
combined.rast <- setValues(Pop[[25]], predict(Final.tree, preds.frame)[, 2])*(JULES.mask>0)
setwd('C:/Users/Oli/Documents/PIES/WHAMv2/mod/tests/test_data/R_outputs')
write.csv(setNames(data.frame(combined.rast[]), 'Unoccupied'), 'Unoccupied_dist.csv',
row.names = F)
plot(combined.rast)
citation()
citation('lhs')
